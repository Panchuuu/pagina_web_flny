<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tienda VIP - Flaites NY ðŸ—½</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/style/style.css" />
    <link rel="icon" type="image/png" href="assets/img/logo_tienda.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@400;700;900&family=Inter:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" />
</head>
<body class="bg-dark text-white">

    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100"></div>

    <nav class="navbar navbar-expand-lg navbar-dark bg-opacity-75 bg-dark border-bottom border-secondary sticky-top">
        <div class="container">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse w-100" id="mainNav">
                <ul class="navbar-nav mx-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
                    <li class="nav-item" id="admin-link" style="display: none;"><a class="nav-link text-danger fw-bold" href="admin-dashboard.html">Admin</a></li>
                    <li class="nav-item"><a class="nav-link active" href="catalogo.html">Tienda VIP</a></li>
                    <li class="nav-item"><a class="nav-link" href="normativas.html">Normativas</a></li>
                    <li class="nav-item"><a class="nav-link" href="https://discord.gg/T99hAzmP5A" target="_blank">Discord</a></li>
                </ul>
                <div class="d-flex align-items-center">
                    <div id="guest-container"><a href="login.html" class="btn btn-outline-warning btn-sm">Iniciar SesiÃ³n</a></div>
                    <div id="notification-bell-container" class="dropdown" style="display: none;">
                        <a href="#" class="nav-link position-relative me-2" role="button" data-bs-toggle="dropdown" aria-expanded="false" title="Notificaciones" onclick="markNotificationsAsRead()">
                            <i class="fas fa-bell"></i>
                            <span id="notification-dot" class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle" style="display: none;"></span>
                        </a>
                        <ul id="notifications-list" class="dropdown-menu dropdown-menu-dark dropdown-menu-end" style="width: 300px;">
                            <li><p class="dropdown-item text-muted text-center">No hay notificaciones</p></li>
                        </ul>
                    </div>
                    <div id="user-container" class="dropdown" style="display: none;">
                        <a href="#" class="nav-link dropdown-toggle d-flex align-items-center" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-circle me-2"></i> Hola, <span id="username-span" class="fw-bold ms-1"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end">
                            <li><a class="dropdown-item" href="perfil.html"><i class="fas fa-history me-2"></i>Ver historial de compras</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><button class="dropdown-item text-danger" onclick="handleLogout()"><i class="fas fa-sign-out-alt me-2"></i>Cerrar SesiÃ³n</button></li>
                        </ul>
                    </div>
                    <a href="carro.html" class="position-relative ms-3" title="Ver carro"><img src="assets/img/carrito-de-compras.png" alt="carro" style="height:24px;"><span id="cart-counter" class="cart-counter-badge">0</span></a>
                </div>
            </div>
        </div>
    </nav>

    <main class="container my-5">
        <div class="text-center mb-5">
            <h1 class="display-5 fw-bold text-uppercase">Nuestra Tienda VIP</h1>
            <p class="lead text-white-50">Adquiere un paquete para apoyar al servidor y obtener beneficios exclusivos.</p>
        </div>
        
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            <div class="col" data-aos="fade-up">
                <div class="card h-100 bg-dark-secondary border-secondary">
                    <img src="assets/img/flny-vip-bronce.png" class="card-img-top" alt="VIP Bronce" />
                    <div class="card-body d-flex flex-column text-white">
                        <h5 class="card-title fw-bold">ðŸ—½ VIP Bronce</h5>
                        <p class="card-text fs-4 fw-bold text-warning">$5.000 CLP / mes</p>
                        <ul class="list-unstyled mt-3 mb-4">
                            <li>âœ… Fila de prioridad en el servidor.</li>
                            <li>âœ… Acceso a vehÃ­culos exclusivos (Nivel 1).</li>
                            <li>âœ… Salario aumentado en un 10%.</li>
                            <li>âœ… Kit de bienvenida mensual.</li>
                        </ul>
                        <button class="btn btn-outline-warning fw-bold mt-auto" onclick="showVipDetails('vip_bronze', 'VIP Bronce', 5000, 'assets/img/flny-vip-bronce.png', 'ObtÃ©n beneficios iniciales...')">Ver Detalles</button>
                    </div>
                </div>
            </div>
            <div class="col" data-aos="fade-up" data-aos-delay="100">
                <div class="card h-100 bg-dark-secondary border-primary">
                    <img src="assets/img/flny-vip-plata.png" class="card-img-top" alt="VIP Plata" />
                    <div class="card-body d-flex flex-column text-white">
                        <h5 class="card-title fw-bold">ðŸ—½ VIP Plata</h5>
                        <p class="card-text fs-4 fw-bold text-primary">$10.000 CLP / mes</p>
                        <ul class="list-unstyled mt-3 mb-4">
                            <li>âœ… Todos los beneficios de Bronce.</li>
                            <li>âœ… Acceso a vehÃ­culos exclusivos (Nivel 2).</li>
                            <li>âœ… CustomizaciÃ³n de personaje avanzada.</li>
                            <li>âœ… Acceso a canal de Discord para VIPs.</li>
                        </ul>
                        <button class="btn btn-outline-primary fw-bold mt-auto" onclick="showVipDetails('vip_silver', 'VIP Plata', 10000, 'assets/img/flny-vip-plata.png', 'Incluye todos los beneficios de Bronce...')">Ver Detalles</button>
                    </div>
                </div>
            </div>
            <div class="col" data-aos="fade-up" data-aos-delay="200">
                <div class="card h-100 bg-dark-secondary border-warning">
                    <img src="assets/img/flny-vip-oro.png" class="card-img-top" alt="VIP Oro" />
                    <div class="card-body d-flex flex-column text-white">
                        <h5 class="card-title fw-bold">ðŸ—½ VIP Oro</h5>
                        <p class="card-text fs-4 fw-bold text-warning">$15.000 CLP / mes</p>
                        <ul class="list-unstyled mt-3 mb-4">
                            <li>âœ… Todos los beneficios de Plata.</li>
                            <li>âœ… Acceso a todas las skins de armas.</li>
                            <li>âœ… Posibilidad de crear tu propia banda.</li>
                            <li>âœ… Soporte prioritario en Discord.</li>
                        </ul>
                        <button class="btn btn-outline-warning fw-bold mt-auto" onclick="showVipDetails('vip_gold', 'VIP Oro', 15000, 'assets/img/flny-vip-oro.png', 'El paquete definitivo...')">Ver Detalles</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="modal fade" id="vipModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content bg-dark-secondary text-white border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-uppercase" id="vipModalLabel">Detalles del VIP</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-5"><img id="vipModalImage" src="" class="img-fluid rounded" alt="Imagen VIP" /></div>
                        <div class="col-md-7 d-flex flex-column">
                            <h3 id="vipModalName" class="fw-bold"></h3><p id="vipModalPrice" class="fs-4 text-warning fw-bold"></p>
                            <p id="vipModalDescription" class="text-muted flex-grow-1"></p><hr class="border-secondary" />
                            <div class="d-flex align-items-center"><label class="form-label me-3 mb-0">Cantidad:</label><input type="number" class="form-control bg-dark text-white border-secondary" id="vipModalQuantity" value="1" min="1" max="10" style="width: 80px" /></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <div id="recipient-input-group" class="me-auto d-none" style="position: relative;">
                        <input type="text" id="recipient-username" class="form-control bg-dark text-white border-secondary" placeholder="Escribe el nombre de un amigo..." autocomplete="off">
                        <div id="recipient-results-list" class="list-group position-absolute w-100" style="z-index: 1056;"></div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="resetModalButtons()">Cerrar</button>
                    <button type="button" class="btn btn-outline-light" id="gift-button" onclick="toggleGiftMode(true)">Regalar</button>
                    <button type="button" class="btn btn-warning fw-bold" id="vipModalAddToCartButton">AÃ±adir a mi Carro</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container">
       <footer class="d-flex flex-wrap justify-content-between align-items-center py-3 my-4 border-top border-secondary">
           <p class="col-md-4 mb-0 text-muted-dark">Â© 2025 Flaites NY Roleplay</p>
           <a href="index.html" class="col-md-4 d-flex align-items-center justify-content-center mb-3 mb-md-0 me-md-auto text-decoration-none"><img src="assets/img/logo_tienda.png" alt="Logo Flaites NY" width="50" /></a>
           <ul class="nav col-md-4 justify-content-end">
               <li class="nav-item"><a href="terminos.html" class="nav-link px-2 footer-link-simple">TÃ©rminos</a></li>
               <li class="nav-item"><a href="https://discord.com/tu-servidor" target="_blank" class="nav-link px-2 footer-link-simple"><i class="fab fa-discord fa-lg"></i></a></li>
           </ul>
       </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="assets/js/cart.js"></script>
    <script src="assets/js/notifications.js"></script>
    <script src="assets/js/auth.js"></script>
<script>
        AOS.init({
            duration: 800, // DuraciÃ³n de la animaciÃ³n en milisegundos
            once: true,    // La animaciÃ³n solo ocurre una vez
        });

        // --- LÃ“GICA DEL MODAL VIP ---
        const vipModalElement = document.getElementById('vipModal');
        if (vipModalElement) {
            const vipModal = new bootstrap.Modal(vipModalElement);
            const addToCartButton = document.getElementById('vipModalAddToCartButton');
            const giftButton = document.getElementById('gift-button');
            const recipientGroup = document.getElementById('recipient-input-group');
            const recipientInput = document.getElementById('recipient-username');
            const resultsList = document.getElementById('recipient-results-list'); // <<< NUEVO
            let debounceTimer; // <<< NUEVO (Para el buscador)

            function toggleGiftMode(isGifting) {
                if (isGifting) {
                    recipientGroup.classList.remove('d-none');
                    giftButton.classList.add('active');
                    addToCartButton.textContent = 'AÃ±adir Regalo al Carro';
                } else {
                    recipientGroup.classList.add('d-none');
                    giftButton.classList.remove('active');
                    addToCartButton.textContent = 'AÃ±adir a mi Carro';
                    recipientInput.value = '';
                    resultsList.innerHTML = ''; // Limpiar resultados al cerrar
                }
            }

            function resetModalButtons() {
                toggleGiftMode(false);
                vipModal.hide();
            }
            
            vipModalElement.querySelector('.btn-close').addEventListener('click', resetModalButtons);

            function showVipDetails(id, name, price, image, description) {
                document.getElementById('vipModalImage').src = image;
                document.getElementById('vipModalName').textContent = name;
                document.getElementById('vipModalPrice').textContent = `$${price.toLocaleString('es-CL')}`;
                document.getElementById('vipModalDescription').textContent = description;
                document.getElementById('vipModalQuantity').value = 1;
                addToCartButton.onclick = function() {
                    const quantity = parseInt(document.getElementById('vipModalQuantity').value);
                    const recipient = recipientInput.value.trim() || null;
                    if (recipient && recipient.length < 3) { return alert("El nombre de usuario del destinatario debe tener al menos 3 caracteres."); }
                    addToCart(id, name, price, image, quantity, recipient);
                    resetModalButtons();
                };
                vipModal.show();
            }
            
            // --- NUEVA LÃ“GICA DE BÃšSQUEDA DE USUARIOS ---

            // FunciÃ³n para mostrar los resultados
            function displaySearchResults(users) {
                resultsList.innerHTML = ''; // Limpiar resultados anteriores
                if (users.length === 0) {
                    resultsList.innerHTML = '<span class="list-group-item list-group-item-dark text-muted">No se encontraron usuarios.</span>';
                    return;
                }

                users.forEach(user => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'list-group-item list-group-item-action bg-dark-secondary text-white d-flex align-items-center';
                    item.innerHTML = `<img src="${user.avatar}" class="rounded-circle me-2" width="30" height="30"> ${user.username}`;
                    
                    // Al hacer clic en un usuario, se rellena el campo y se oculta la lista
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        recipientInput.value = user.username;
                        resultsList.innerHTML = '';
                    });
                    
                    resultsList.appendChild(item);
                });
            }

            // Event listener para el campo de texto del destinatario
            recipientInput.addEventListener('input', () => {
                const searchTerm = recipientInput.value.trim();
                resultsList.innerHTML = ''; // Limpiar inmediatamente
                
                clearTimeout(debounceTimer); // Cancelar el temporizador anterior

                if (searchTerm.length < 2) {
                    return; // No buscar si es muy corto
                }

                // Usamos un "debounce" para no spamear al servidor con una peticiÃ³n por cada tecla.
                // Solo buscarÃ¡ 300ms despuÃ©s de que el usuario deje de teclear.
                debounceTimer = setTimeout(async () => {
                    try {
                        const token = localStorage.getItem('sessionToken');
                        if (!token) return;

                        const response = await fetch(`http://localhost:3002/api/users/search?term=${searchTerm}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        if (response.ok) {
                            const users = await response.json();
                            displaySearchResults(users);
                        }
                    } catch (error) {
                        console.error("Error al buscar usuarios:", error);
                    }
                }, 300);
            });
            
            // Ocultar resultados si se hace clic fuera
            document.addEventListener('click', (e) => {
                if (!recipientGroup.contains(e.target)) {
                    resultsList.innerHTML = '';
                }
            });
        }
    </script>
</body>
</html>